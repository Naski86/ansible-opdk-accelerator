---
- name: Update Postgres Standby variables
  hosts: pgstandby
  roles:
    - { role: apigee-opdk-settings-private-address, tags: ['minimum', 'cache', 'ds', 'ms', 'rmp', 'r', 'mp', 'qpid', 'pg', 'pgmaster', 'pgstandby', 'org', 'validate', 'validate-cleanup']  }

- name: Add Postgres Standby servers beyond one
  hosts: pgmaster
  tasks:
    - name: Setup replication variable
      set_fact:
        replication_string: ''

    - name: Create replication string
      set_fact:
        replication_string: "{{ replication_string }}host     replication     apigee {{ hostvars[item]['private_address'] }}/32     trust\n"
      with_items: "{{ groups['pgstandby'] }}"

    - name: Update attribute
      set_fact:
        replication_string: "conf_pg_hba_replication.connection={{ replication_string }}"

    - debug:
        var: replication_string
